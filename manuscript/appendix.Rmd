---
title: 'Appendix for "NGO Repression as a Predictor of Worsening Human Rights Abuses"'
short-title: 'Appendix for "NGO Repression"'
author:
- name: Suparna Chaudhry
  affiliation: Lewis & Clark College
  email: schaudhry@lclark.edu
  url: http://www.suparnachaudhry.com/
- name: Andrew Heiss
  affiliation: Georgia State University
  email: aheiss@gsu.edu
  url: https://www.andrewheiss.com/
date: "November 19, 2021"
# published: Under review
code-repo: "Access the code and full analysis notebook at <https://stats.andrewheiss.com/cautioning-canary/>"
reference-section-title: References
bibliography: bibliography.bib
toc: false
appendix: true
mainfont: Cochineal
sansfont: Inter
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# Figure out output format
is_docx <- knitr::pandoc_to("docx") | knitr::pandoc_to("odt")
is_latex <- knitr::pandoc_to("latex")
is_html <- knitr::pandoc_to("html")

# Word-specific things
table_format <- ifelse(is_docx, "huxtable", "kableExtra")  # Huxtable tables
conditional_dpi <- ifelse(is_docx, 300, 300)  # Higher DPI
conditional_align <- ifelse(is_docx, "default", "center")  # Word doesn't support align

# Knitr options
knitr::opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE,
  tidy.opts = list(width.cutoff = 120),  # Code width
  fig.retina = 3, dpi = conditional_dpi,
  fig.width = 7, fig.asp = 0.618,
  fig.align = conditional_align, out.width = "100%",
  fig.path = "output/figures/",
  cache.path = "output/_cache/",
  fig.process = function(x) {  # Remove "-1" from figure names
    x2 = sub('-\\d+([.][a-z]+)$', '\\1', x)
    if (file.rename(x, x2)) x2 else x
  }
)

# R options
options(
  width = 90,  # Output width
  dplyr.summarise.inform = FALSE,  # Turn off dplyr's summarize() auto messages
  knitr.kable.NA = "",  # Make NAs blank in kables
  kableExtra.latex.load_packages = FALSE,  # Don't add LaTeX preamble stuff
  modelsummary_factory_default = table_format,  # Set modelsummary backend
  modelsummary_format_numeric_latex = "plain"  # Don't use siunitx
)

# modelsummary regression table notes
if (is_latex) {
  model_note <- "Posterior means; 95\\\\% credible intervals in brackets" 
} else {
  model_note <- "Posterior means; 95% credible intervals in brackets"
}
```

```{r libraries-data, include=FALSE}
library(tidyverse)
library(targets)
library(kableExtra)
library(modelsummary)

if (is_docx) {
  library(huxtable)
}

withr::with_dir(here::here(), {
  source(tar_read(plot_funs))
  
  # Model tables
  tar_load(c(models_paper_pts, models_paper_lhr))
  
  # Load lookup list for coefficients in regression tables
  tar_load(coef_list)
})
```

# Modeling approach

We use Stan [@stan] through R [@r-project] and brms [@brms-jss] to estimate our models. We generate 4 MCMC chains for each model with 2,000 iterations in each chain, 1,000 of which are used for warmup. All chains converge; we assess convergence with visual inspection.

To check for robustness, we also ran models using both country and regional random effects, but doing so made no noticeable difference in the results—for the sake of computational efficiency, we thus do not include regional effects.

Complete results from all the models, along with posterior predictive checks, goodness-of-fit measures, and prediction diagnostics are all available at a companion statistical analysis notebook at <https://doi.org/10.17605/OSF.IO/MTR6X>. Our general modeling approach can be summarized as follows:

## PTS models

### Equation

$$
\begin{aligned}
& \textbf{Likelihood for ordinal outcome} \\
& \text{Political Terror Scores (PTS)} \\
y_{i, t+1} \sim&\ \operatorname{Categorical}(p_{i, t + 1}) \\
\ \\
& \textbf{Parameters} \\
\operatorname{logit}(p_i) =&\ \alpha_{j[i]} - \phi_{k, t + 1} \\
\phi_{k, t + 1} =&\ \beta_1 \text{PTS}_{i, t} + \beta_2 \text{PTS}_{i, t - 1} + \\
&\ \beta_3 \text{Outcome}_{i, t} + \beta_4 \text{Polyarchy}_{i, t} + \\
&\ \beta_5 \log (\text{GDP per capita}) + \\
&\ \beta_6 \text{Trade as } \% \text{ of GDP}_{i, t} + \\
&\ \beta_7 \text{Armed conflict}_{i, t} \\ \\
\alpha_j \sim&\ \mathcal{N} (\mu_{\alpha_j}, \sigma_{\alpha_j}), \text{ for country } j \text{ in } 1 .. J & \text{[country-specific intercepts]} \\ \\
\ \\
& \textbf{Priors} \\
\mu_{\alpha_j} \sim&\ \mathcal{N}(0, 10) & \text{[country-specific intercepts]} \\
\beta_{1-7} \sim&\ \mathcal{N}(0, 3) & \text{[population effects]} \\
\sigma_{\alpha_j} \sim&\ \operatorname{Cauchy}(0, 1) & \text{[sd for population \& country]}
\end{aligned}
$$

### R code

The actual R code for this model is included in the replication code at <https://doi.org/10.17605/OSF.IO/MTR6X>. This is a simplified representation of the **brms** [@brms-jss] model code.

```{r echo=TRUE, eval=FALSE}
# Ordinal logistic regression for political terror
# (replace `cs_repression` with different measures of de jure and 
# de facto civil society repression: barriers_total, advocacy, entry, 
# funding, and v2csreprss)
brm(
  bf(PTS_lead1 ~ cs_repression + cs_repression_lag1 +
       PTS + v2x_polyarchy + gdpcap_log +
       un_trade_pct_gdp + armed_conflict + (1 | gwcode)),
  family = cumulative(),
  prior = c(set_prior("normal(0, 10)", class = "Intercept"),
            set_prior("normal(0, 3)", class = "b"),
            set_prior("cauchy(0, 1)", class = "sd")),
  ...
)
```

## Latent human rights models

### Equation

$$
\begin{aligned}
& \textbf{Likelihood for continuous outcome} \\
& \text{Latent human rights (LHR) values} \\
y_{i, t+1} \sim&\ \mathcal{N}(y^*_{i, t + 1}, \sigma_i) \\
\ \\
& \textbf{Parameters} \\
y^*_{i, t + 1} =&\ \alpha_{j[i]} + \beta_1 \text{LHR}_{i, t} +  \beta_2 \text{LHR}_{i, t - 1}\\
&\ \beta_3 \text{Outcome}_{i, t} + \beta_4 \text{Polyarchy}_{i, t} + \\
&\ \beta_5 \log (\text{GDP per capita}) + \\
&\ \beta_6 \text{Trade as } \% \text{ of GDP}_{i, t} + \\
&\ \beta_7 \text{Armed conflict}_{i, t}\\ \\
\alpha_j \sim&\ \mathcal{N} (\mu_{\alpha_j}, \sigma_{\alpha_j}), \text{ for country } j \text{ in } 1 .. J & \text{[country-specific intercepts]} \\ \\
& \textbf{Priors} \\
\mu_{\alpha_j} \sim&\ \mathcal{N}(0, 10) & \text{[country-specific intercepts]} \\
\beta_{1-7} \sim&\ \mathcal{N}(0, 3) & \text{[population effects]} \\
\sigma_i, \sigma_{\alpha_j} \sim&\ \operatorname{Cauchy}(0, 1) & \text{[sd for population \& country]}
\end{aligned}
$$

### R code

The actual R code for this model is included in the replication code at <https://doi.org/10.17605/OSF.IO/MTR6X>. This is a simplified representation of the **brms** [@brms-jss] model code.

```{r echo=TRUE, eval=FALSE}
# Gaussian regression for latent human rights
# (replace `cs_repression` with different measures of de jure and 
# de facto civil society repression: barriers_total, advocacy, entry, 
# funding, and v2csreprss)
brm(
  bf(latent_hr_mean_lead1 ~ cs_repression + cs_repression_lag1 +
       latent_hr_mean + v2x_polyarchy + gdpcap_log +
       un_trade_pct_gdp + armed_conflict + (1 | gwcode)),
  family = gaussian(),
  prior = c(set_prior("normal(0, 10)", class = "Intercept"),
            set_prior("normal(0, 3)", class = "b"),
            set_prior("cauchy(0, 1)", class = "sd")),
  ...
)
```

\newpage

# Improved cases

```{r tbl-improved-pts}
tbl_improved_pts <- tribble(
               ~Country, ~Year,   ~Actual, ~`Baseline prediction`, ~`Total NGO barriers included`, ~`Civil society repression included`,
            "Guatemala", 2013L, "Level 3", "Level 2",                    "Level 3",                          "Level 3",
               "Kosovo", 2012L, "Level 1", "Level 2",                    "Level 1",                          "Level 1",
         "Sierra Leone", 2011L, "Level 3", "Level 2",                    "Level 3",                                "—",
  "Congo - Brazzaville", 2011L, "Level 3", "Level 2",                    "Level 3",                          "Level 3",
              "Somalia", 2013L, "Level 5", "Level 4",                    "Level 5",                                "—",
              "Bahrain", 2011L, "Level 3", "Level 2",                    "Level 3",                          "Level 3",
              "Bahrain", 2013L, "Level 3", "Level 2",                    "Level 3",                          "Level 3",
                "Libya", 2011L, "Level 4", "Level 5",                          "—",                          "Level 4"
  )

tbl_improved_pts_caption <- "Country-year cases where including civil society restrictions improved PTS predictions"

if (!is_docx) {
  tbl_improved_pts %>% 
    kbl(align = "llcccc",
        booktabs = TRUE, linesep = "\\addlinespace",
        caption = tbl_improved_pts_caption) %>% 
    kable_styling(latex_options = c("hold_position")) %>% 
    row_spec(0, bold = TRUE) %>% 
    column_spec(1, width = "0.1\\\\textwidth") %>% 
    column_spec(2, width = "0.05\\\\textwidth") %>% 
    column_spec(3:6, width = "0.16\\\\textwidth")
} else {
  tbl_improved_pts %>% 
    hux() %>% 
    set_font_size(10) %>%
    set_all_padding(3) %>% 
    set_align(everywhere, 1:2, "left") %>% 
    set_align(everywhere, 3:6, "center") %>% 
    set_bold(1, everywhere) %>%
    set_bottom_border(1, everywhere) %>%
    set_width(1) %>% 
    set_wrap(TRUE) %>% 
    huxtable::set_caption(tbl_improved_pts_caption) %>% 
    huxtable::as_flextable()
}
```

\newpage

\blandscape

# Complete model results

\memSingleSmall

```{r tbl-models-pts}
model_names_tbl_pts <- c("Total barriers",
                         "Barriers to advocacy",
                         "Barriers to entry",
                         "Barriers to funding",
                         "Civil society repression")

names(models_paper_pts) <- model_names_tbl_pts

tbl_reg_pts_caption <- "Full results from ordered logistic regression models predicting political terror"

tbl_reg_pts <- modelsummary(models_paper_pts,
                            output = table_format,
                            statistic = "[{conf.low}, {conf.high}]",
                            coef_map = coef_list,
                            gof_omit = "ELPD",
                            escape = FALSE,
                            caption = tbl_reg_pts_caption,
                            notes = c(model_note),
                            longtable = TRUE) 

if (!is_docx) {
  tbl_reg_pts %>% 
    kable_styling() %>% 
    add_header_above(header = c(" " = 1, "Outcome in t + 1" = 5))
    # kable_styling(font_size = ifelse(is_latex, 7, NA)) %>%
    # column_spec(1, width = "0.75in", latex_valign = "b") %>%
    # column_spec(2:6, width = "1.3in", latex_valign = "b")
    # column_spec(1, width = "0.10\\\\textwidth") %>%
    # column_spec(2:6, width = "0.14\\\\textwidth")
} else {
  tbl_reg_pts %>% 
    set_font_size(10) %>% 
    set_all_padding(1) %>% 
    set_align(everywhere, 2:6, "center") %>% 
    set_bold(1, everywhere) %>% 
    # set_col_width(1, 0.1) %>% 
    # set_col_width(2:6, 0.14) %>% 
    set_width(1) %>% 
    set_wrap(TRUE) %>% 
    huxtable::set_caption(tbl_reg_pts_caption) %>% 
    huxtable::as_flextable()
}
```

\clearpage

```{r tbl-models-lhr}
model_names_tbl_lhr <- c("Total barriers",
                         "Barriers to advocacy",
                         "Barriers to entry",
                         "Barriers to funding",
                         "Civil society repression")

names(models_paper_lhr) <- model_names_tbl_lhr

tbl_reg_lhr_caption <- "Full results from Gaussian regression models predicting latent human rights"

tbl_reg_lhr <- modelsummary(models_paper_lhr,
                            output = table_format,
                            statistic = "[{conf.low}, {conf.high}]",
                            coef_map = coef_list,
                            gof_omit = "ELPD",
                            escape = FALSE,
                            caption = tbl_reg_lhr_caption,
                            notes = c(model_note),
                            longtable = TRUE)

if (!is_docx) {
  tbl_reg_lhr %>% 
    kable_styling() %>% 
    add_header_above(header = c(" " = 1, "Outcome in t + 1" = 5))
    # kable_styling(font_size = ifelse(is_latex, 7.5, NA)) %>% 
    # column_spec(1, width = "0.10\\\\textwidth") %>% 
    # column_spec(2:6, width = "0.14\\\\textwidth")
} else {
  tbl_reg_lhr %>% 
    set_font_size(10) %>% 
    set_all_padding(1) %>% 
    set_align(everywhere, 2:6, "center") %>% 
    set_bold(1, everywhere) %>% 
    set_width(1) %>% 
    set_wrap(TRUE) %>% 
    huxtable::set_caption(tbl_reg_lhr_caption) %>% 
    huxtable::as_flextable()
}
```

\clearpage

\elandscape

\memSingle
